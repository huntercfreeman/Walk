@using Walk.Extensions.CompilerServices.Syntax
@using Walk.Extensions.CompilerServices.Syntax.Enums
@using Walk.Extensions.CompilerServices.Syntax.NodeValues
@using Walk.Extensions.CompilerServices.Syntax.Nodes
@using Walk.Extensions.CompilerServices.Syntax.Nodes.Enums
@using Walk.Extensions.CompilerServices.Syntax.Values
@using Walk.TextEditor.RazorLib.TextEditors.Models.Internals

@*
    I'm making changes to the C# Compiler Service storage.
    I encountered an infinite loop in the UI when I hovered a certain generic variable.
    The TypeSyntaxDisplay was rendering GenericSyntaxDisplay which then rendered TypeSyntaxDisplay, repeat...
    This spiked my memory, I was able to stop the app with Task Manager, but I want to avoid this happening again at all costs until I am 100% certain
    the new storage won't have an infinite loop in the UI.
*@
@if (SyntaxViewModel.Depth < 6)
{
	var syntaxViewModelLocal = SyntaxViewModel;
	
	string? prefixText;
	string? text;
	string? textCssClass;
	SyntaxNodeValue variableDeclarationNode;
	VariableDeclarationTraits variableDeclarationMetadata;
	
	if (syntaxViewModelLocal.DefinitionNode.IsDefault() && syntaxViewModelLocal.TargetNode.IsDefault() && syntaxViewModelLocal.TargetSymbol.IsDefault())
	{
		prefixText = "(null)";
		text = null;
		textCssClass = "di_variable";
		variableDeclarationNode = default;
		variableDeclarationMetadata = default;
	}
	else if (!syntaxViewModelLocal.DefinitionNode.IsDefault() && syntaxViewModelLocal.DefinitionNode.SyntaxKind == SyntaxKind.VariableDeclarationNode)
	{
		variableDeclarationNode = syntaxViewModelLocal.DefinitionNode;
		variableDeclarationMetadata = syntaxViewModelLocal.ExtendedCompilerService.VariableDeclarationValueList[variableDeclarationNode.MetaIndex];
		
		prefixText = string.Empty;
		text = syntaxViewModelLocal.GetTextFromTextSpan(variableDeclarationNode.IdentifierToken.TextSpan);
		
		if (variableDeclarationMetadata.VariableKind == VariableKind.Field)
			textCssClass = "di_te_field";
		else if (variableDeclarationMetadata.VariableKind == VariableKind.Property)
			textCssClass = "di_te_property";
		else if (variableDeclarationMetadata.VariableKind == VariableKind.EnumMember)
			textCssClass = "di_te_property";
		else
			textCssClass = "di_variable";
		
		// 'variableDeclarationNode' was set at the start of code block.
	}
	else if (!syntaxViewModelLocal.TargetNode.IsDefault() && syntaxViewModelLocal.TargetNode.SyntaxKind == SyntaxKind.VariableReferenceNode)
	{
		prefixText = "(reference)";
		text = syntaxViewModelLocal.GetTextFromTextSpan(syntaxViewModelLocal.TargetNode.IdentifierToken.TextSpan);
		textCssClass = "di_variable";
		variableDeclarationNode = default;
		variableDeclarationMetadata = default;
	}
	else if (!syntaxViewModelLocal.TargetSymbol.IsDefault() &&
			 (syntaxViewModelLocal.TargetSymbol.SyntaxKind == SyntaxKind.VariableSymbol ||
			  	syntaxViewModelLocal.TargetSymbol.SyntaxKind == SyntaxKind.FieldSymbol ||
			  	syntaxViewModelLocal.TargetSymbol.SyntaxKind == SyntaxKind.PropertySymbol ||
			  	syntaxViewModelLocal.TargetSymbol.SyntaxKind == SyntaxKind.EnumMemberSymbol))
	{
		prefixText = "(symbol)";
		text = syntaxViewModelLocal.GetTextFromTextSpan(syntaxViewModelLocal.TargetSymbol.TextSpan);
		textCssClass = "di_variable";
		variableDeclarationNode = default;
		variableDeclarationMetadata = default;
	}
	else
	{
		prefixText = "(unrecognizable-state)";
		text = null;
		textCssClass = "di_variable";
		variableDeclarationNode = default;
		variableDeclarationMetadata = default;
	}
    
    <span>
    	@if (syntaxViewModelLocal.Depth == 0 && !string.IsNullOrWhiteSpace(prefixText))
    	{
    		<span>
    			@prefixText
    			&nbsp;
    		</span>
    	}
    	
    	@if (!variableDeclarationMetadata.IsDefault())
    	{
    		var syntaxViewModel = new SyntaxViewModel(
    		    SyntaxViewModel.ExtendedCompilerService,
    		    SyntaxViewModel.TextEditorService,
    		    SyntaxViewModel.ResourceUri,
    			targetSymbol: default,
    			targetNode: default,
    			definitionNode: default,
    			depth: syntaxViewModelLocal.Depth + 1);
        	<TypeSyntaxDisplay SyntaxViewModel="syntaxViewModel" TypeReference="variableDeclarationMetadata.ResultTypeReference"/>
        	<text>&nbsp;</text>
        }
        else
        {
        	<span class="di_keyword">
        		undefined
        		&nbsp;
        	</span>
        }
    	
    	@if (!string.IsNullOrWhiteSpace(text))
    	{
    		var classCssString = syntaxViewModelLocal.DefinitionNode.IsDefault()
    			? string.Empty
    			: "di_te_syntax-onclick";
    	
    		<span class="@classCssString @textCssClass"
    			  @onclick="() => syntaxViewModelLocal.HandleOnClick(TextEditorService, SyntaxKind.VariableDeclarationNode)">
    			@text
    		</span>
    	}
    	
    	@if (!variableDeclarationMetadata.IsDefault() && variableDeclarationMetadata.VariableKind == VariableKind.Property)
        {
        	<span>
            	{
            	
            	<text><span class="di_keyword"> get</span>;</text>
            	
            	@if (variableDeclarationMetadata.HasSetter)
            	{
            		<text><span class="di_keyword"> set</span>;</text>
            	}
            	
            	}
        	</span>
        }
    </span>
}
